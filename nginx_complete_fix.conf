# 完整的Nginx配置修复
# 在现有的 location /api/ 块中添加以下行：

location /api/ {
    proxy_pass http://pkb_test_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 🔧 新增：修复重定向URL，确保HTTPS
    proxy_redirect http://pkb-test.kmchat.cloud/ https://pkb-test.kmchat.cloud/;
    proxy_redirect http://$host/ https://$host/;
    
    # 🔧 新增：额外的HTTPS标识头
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header X-Url-Scheme $scheme;
    
    # 🔧 新增：通用重定向修复（可选，更强大）
    # proxy_redirect ~^http://([^/]+)(.*)$ https://$1$2;
}
