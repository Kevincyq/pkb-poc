# æ•°æ®æµå®Œæ•´æ€§éªŒè¯

## 1ï¸âƒ£ **æœç´¢åŠŸèƒ½æ•°æ®æµ**

### å‰ç«¯è§¦å‘
1. ç”¨æˆ·åœ¨ `SearchOverlay` è¾“å…¥å…³é”®è¯ âœ…
2. `performSearch` å‡½æ•°æ„å»ºURL: `/api/search?q={query}&top_k=10&search_type=hybrid` âœ…
3. ä½¿ç”¨ `api.get()` å‘é€è¯·æ±‚ï¼ˆè‡ªåŠ¨æ·»åŠ baseURLå’Œheadersï¼‰ âœ…

### åç«¯å¤„ç†
4. FastAPIæ¥æ”¶è¯·æ±‚: `GET /api/search` âœ…
5. URLè§£ç : `unquote(query)` âœ…
6. åˆ›å»º `SearchService(db)` âœ…
7. è°ƒç”¨ `search_service.search(decoded_query, top_k, search_type, filters)` âœ…
8. æ ¹æ®search_typeåˆ†å‘ï¼š
   - `keyword`: `_keyword_search()` âœ…
   - `semantic`: `_semantic_search()` âœ…
   - `hybrid`: ä¸¤è€…ç»“åˆ âœ…
9. æŸ¥è¯¢æ•°æ®åº“ï¼ˆChunk + Content + Categoryï¼‰ âœ…
10. æ ¼å¼åŒ–ç»“æœ: `_format_search_results()` âœ…
11. è¿”å›JSON: `{query, results, total, response_time, search_type}` âœ…

### å‰ç«¯å±•ç¤º
12. æ¥æ”¶response.data.results âœ…
13. ä½¿ç”¨ `HighlightText` ç»„ä»¶é«˜äº®å…³é”®è¯ âœ…
14. æ¸²æŸ“ `List.Item` å±•ç¤ºæœç´¢ç»“æœ âœ…
15. `ErrorBoundary` æ•è·ä»»ä½•æ¸²æŸ“é”™è¯¯ âœ…

**âœ… æœç´¢åŠŸèƒ½æ•°æ®æµå®Œæ•´ï¼Œæ— æ–­ç‚¹**

---

## 2ï¸âƒ£ **ç¼©ç•¥å›¾æ˜¾ç¤ºæ•°æ®æµ**

### å‰ç«¯è¯·æ±‚ï¼ˆDocumentCardï¼‰
1. ç»„ä»¶æ¥æ”¶props: `{sourceUri, title, modality}` âœ…
2. æ£€æŸ¥ `modality === 'image'` âœ…
3. è°ƒç”¨ `getThumbnailUrl(sourceUri)` âœ…
4. ä» `sourceUri` æå–æ–‡ä»¶å: `sourceUri.replace('webui://', '')` âœ…
5. æ„å»ºç¼©ç•¥å›¾URL: `${apiBaseUrl}/files/thumbnail/${encodeURIComponent(fileName)}` âœ…
6. è®¾ç½® `<img src={thumbnailUrl} />` âœ…

### åç«¯å¤„ç†ï¼ˆfiles.pyï¼‰
7. FastAPIæ¥æ”¶: `GET /api/files/thumbnail/{filename}` âœ…
8. URLè§£ç æ–‡ä»¶åï¼ˆåœ¨get_file_pathä¸­ï¼‰ âœ…
9. è°ƒç”¨ `get_file_path(filename, db)`:
   - æŸ¥è¯¢æ•°æ®åº“: `Content.source_uri == f"webui://{filename}"` âœ…
   - æˆ–æŸ¥è¯¢: `Content.title == filename` âœ…
   - è¿”å› `content.meta['file_path']` æˆ– fallbackè·¯å¾„ âœ…
10. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ âœ…
11. æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒï¼ˆSUPPORTED_IMAGE_FORMATSï¼‰ âœ…
12. è°ƒç”¨ `get_or_create_thumbnail(file_path, filename)`:
    - æ£€æŸ¥ç¼©ç•¥å›¾ç¼“å­˜ âœ…
    - å¦‚ä¸å­˜åœ¨ï¼Œè°ƒç”¨ `create_and_save_thumbnail()` âœ…
    - ä½¿ç”¨PILç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ300x200, quality=85ï¼‰ âœ…
    - ä¿å­˜åˆ° `/tmp/pkb_thumbnails/` âœ…
13. è¿”å› `FileResponse(thumbnail_path, media_type="image/jpeg")` âœ…

### æµè§ˆå™¨æ¸²æŸ“
14. æ¥æ”¶JPEGå›¾ç‰‡æ•°æ® âœ…
15. æµè§ˆå™¨ç¼“å­˜ï¼ˆCache-Control: max-age=86400ï¼‰ âœ…
16. æ¸²æŸ“åˆ° `<img>` æ ‡ç­¾ âœ…
17. å¦‚åŠ è½½å¤±è´¥ï¼Œ`onError` è®¾ç½® `thumbnailError=true` æ˜¾ç¤ºå ä½ç¬¦ âœ…

**âœ… ç¼©ç•¥å›¾æ˜¾ç¤ºæ•°æ®æµå®Œæ•´ï¼Œæ— æ–­ç‚¹**

---

## 3ï¸âƒ£ **æ–‡ä»¶é¢„è§ˆæ•°æ®æµ**

### å‰ç«¯è§¦å‘ï¼ˆCollection/Detail.tsxï¼‰
1. ç”¨æˆ·ç‚¹å‡»æ–‡ä»¶å¡ç‰‡ âœ…
2. `handleDocumentClick(document)` è®¾ç½® `previewDocument` âœ…
3. `Modal` æ‰“å¼€ï¼Œ`open={!!previewDocument}` âœ…
4. æ£€æŸ¥ `modality === 'image'` âœ…
5. ä» `source_uri` æå–æ–‡ä»¶å: `previewDocument.source_uri.replace(/^(webui|nextcloud):\/\//, '')` âœ…
6. æ„å»ºåŸå›¾URL: `${apiBaseUrl}/files/${encodeURIComponent(fileName)}` âœ…
7. è®¾ç½® `<img src={...} />` åœ¨Modalä¸­ âœ…

### åç«¯å¤„ç†ï¼ˆfiles.pyï¼‰
8. FastAPIæ¥æ”¶: `GET /api/files/{filename}` âœ… **ï¼ˆåˆšåˆšæ·»åŠ çš„ç«¯ç‚¹ï¼‰**
9. URLè§£ç æ–‡ä»¶å âœ…
10. è°ƒç”¨ `get_file_path(filename, db)` âœ…
11. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ âœ…
12. æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®š `media_type`:
    - `.jpg/.jpeg`: `image/jpeg` âœ…
    - `.png`: `image/png` âœ…
    - `.pdf`: `application/pdf` âœ…
    - å…¶ä»–: `application/octet-stream` âœ…
13. è¿”å› `FileResponse(path, media_type, Content-Disposition: inline)` âœ…

### æµè§ˆå™¨æ¸²æŸ“
14. æ¥æ”¶åŸå§‹æ–‡ä»¶æ•°æ®ï¼ˆæ— å‹ç¼©ï¼‰ âœ…
15. æ ¹æ® `Content-Disposition: inline` åœ¨æµè§ˆå™¨å†…é¢„è§ˆ âœ…
16. æ¸²æŸ“é«˜æ¸…åŸå›¾åˆ° `<img>` âœ…
17. å¦‚åŠ è½½å¤±è´¥ï¼Œ`onError` æ˜¾ç¤ºå ä½ç¬¦ âœ…

**âœ… æ–‡ä»¶é¢„è§ˆæ•°æ®æµå®Œæ•´ï¼Œåˆšåˆšä¿®å¤çš„ç«¯ç‚¹ç¼ºå¤±é—®é¢˜**

---

## 4ï¸âƒ£ **åˆé›†å†…å®¹æŸ¥è¯¢æ•°æ®æµ**

### å‰ç«¯è¯·æ±‚ï¼ˆCollection/Detail.tsxï¼‰
1. é¡µé¢åŠ è½½ï¼Œä»URLå‚æ•°è·å– `categoryName` âœ…
2. ä½¿ç”¨ `useQuery` è°ƒç”¨ `getCategoryDocuments(categoryName, searchQuery)` âœ…
3. æ„å»ºURL: `/api/search/category/${encodeURIComponent(categoryName)}?q={searchQuery}&top_k=20` âœ…
4. å‘é€ `api.get()` è¯·æ±‚ âœ…

### åç«¯å¤„ç†ï¼ˆsearch.py â†’ search_service.pyï¼‰
5. FastAPIæ¥æ”¶: `GET /api/search/category/{category_id}` âœ…
6. URLè§£ç æŸ¥è¯¢å‚æ•° âœ…
7. è°ƒç”¨ `search_service.search_by_category(category_id, decoded_q, top_k)` âœ…
8. æŸ¥æ‰¾åˆ†ç±»:
   - å°è¯•UUIDæ ¼å¼æŸ¥æ‰¾ `Category.id == uuid_obj` âœ…
   - å°è¯•åç§°æŸ¥æ‰¾ `Category.name == category_identifier` âœ…
9. æ„å»ºæŸ¥è¯¢ï¼ˆ**å·²ä¿®å¤ä¸ºContentçº§åˆ«**ï¼‰:
   ```python
   base_query = self.db.query(
       Content, Category.name, ...
   ).select_from(Content).join(
       ContentCategory, Content.id == ContentCategory.content_id
   ).join(
       Category, ContentCategory.category_id == Category.id
   ).filter(Category.id == category.id)
   ```
   âœ… **ç›´æ¥æŸ¥è¯¢Contentï¼Œé¿å…Chunké‡å¤**
   
10. å¦‚æœ‰æœç´¢æŸ¥è¯¢ï¼Œè¿‡æ»¤:
    ```python
    Content.text.ilike(f"%{query}%")
    Content.title.ilike(f"%{query}%")
    ```
    âœ… **ä½¿ç”¨Content.textè€ŒéChunk.text**
    
11. æ’åº: `desc(ContentCategory.confidence), desc(Content.created_at)` âœ…
12. é™åˆ¶æ•°é‡: `limit(top_k)` âœ… **ç°åœ¨è¿”å›top_kä¸ªContentï¼Œè€ŒéChunk**
13. ç›´æ¥æ ¼å¼åŒ–ç»“æœï¼ˆæ— éœ€å»é‡ï¼‰:
    ```python
    for content, category_name, ... in results:
        formatted_results.append({
            "content_id": str(content.id),
            "chunk_id": str(content.id),  # ä½¿ç”¨content_id
            "title": content.title,
            "source_uri": content.source_uri,
            ...
        })
    ```
    âœ… **ä¸€å¯¹ä¸€æ˜ å°„ï¼Œæ— é‡å¤**
    
14. è¿”å›JSON: `{category, query, results, total}` âœ…

### å‰ç«¯å±•ç¤º
15. æ¥æ”¶ `data.results` âœ…
16. ä½¿ç”¨ `map()` æ¸²æŸ“ `DocumentCard` âœ…
17. æ¯ä¸ªæ–‡ä»¶ä¸€ä¸ªå¡ç‰‡ï¼Œæ˜¾ç¤ºç¼©ç•¥å›¾å’Œæ ‡é¢˜ âœ…
18. ç‚¹å‡»å¡ç‰‡è§¦å‘é¢„è§ˆ âœ…

**âœ… åˆé›†å†…å®¹æŸ¥è¯¢æ•°æ®æµå®Œæ•´ï¼ŒChunké‡å¤é—®é¢˜å·²ä¿®å¤**

---

## ğŸ” **å…³é”®ä¿®å¤ç‚¹æ€»ç»“**

### âœ… å·²ä¿®å¤é—®é¢˜
1. **æ–‡ä»¶é¢„è§ˆç«¯ç‚¹ç¼ºå¤±**: æ·»åŠ äº† `GET /api/files/{filename}` âœ…
2. **åˆé›†æŸ¥è¯¢é‡å¤**: æ”¹ä¸ºContentçº§åˆ«æŸ¥è¯¢ï¼Œé¿å…Chunkå¯¼è‡´çš„é‡å¤/é—æ¼ âœ…
3. **Reactæ¸²æŸ“é”™è¯¯**: ç§»é™¤æ‰€æœ‰ `dangerouslySetInnerHTML`ï¼Œä½¿ç”¨å®‰å…¨çš„Reactç»„ä»¶ âœ…
4. **é¢„è§ˆå›¾ç‰‡è´¨é‡**: ä½¿ç”¨åŸå›¾APIè€Œéç¼©ç•¥å›¾API âœ…

### âš ï¸ æ½œåœ¨è¾¹ç•Œæƒ…å†µ
1. **æ–‡ä»¶åç‰¹æ®Šå­—ç¬¦**: å·²ä½¿ç”¨ `encodeURIComponent` å¤„ç† âœ…
2. **æ–‡ä»¶ä¸å­˜åœ¨**: æœ‰å®Œæ•´çš„404é”™è¯¯å¤„ç† âœ…
3. **æ•°æ®åº“è®°å½•ç¼ºå¤±**: æœ‰fallbackåˆ°æ–‡ä»¶ç³»ç»Ÿç›´æ¥æŸ¥æ‰¾ âœ…
4. **ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥**: æœ‰é”™è¯¯å¤„ç†å’Œå ä½ç¬¦æ˜¾ç¤º âœ…
5. **æœç´¢æŸ¥è¯¢ä¸ºç©º**: åç«¯è¿”å›ç©ºç»“æœï¼Œå‰ç«¯æ˜¾ç¤º"æœªæ‰¾åˆ°ç›¸å…³å†…å®¹" âœ…

---

## ğŸ“Š **æ•°æ®æµå›¾æ€»ç»“**

```
æœç´¢æµ: 
ç”¨æˆ·è¾“å…¥ â†’ SearchOverlay â†’ /api/search â†’ SearchService 
â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ æ ¼å¼åŒ–ç»“æœ â†’ HighlightTextæ¸²æŸ“

ç¼©ç•¥å›¾æµ:
DocumentCard â†’ getThumbnailUrl â†’ /api/files/thumbnail/{filename} 
â†’ get_file_path â†’ æ•°æ®åº“æŸ¥æ‰¾ â†’ ç”Ÿæˆ/ç¼“å­˜ç¼©ç•¥å›¾ â†’ FileResponse

é¢„è§ˆæµ:
ç‚¹å‡»å¡ç‰‡ â†’ Modalæ‰“å¼€ â†’ /api/files/{filename} 
â†’ get_file_path â†’ æ•°æ®åº“æŸ¥æ‰¾ â†’ FileResponse(åŸå›¾) â†’ æµè§ˆå™¨é¢„è§ˆ

åˆé›†æµ:
é¡µé¢åŠ è½½ â†’ useQuery â†’ /api/search/category/{name} 
â†’ search_by_category â†’ Contentçº§åˆ«æŸ¥è¯¢ â†’ æ ¼å¼åŒ–ç»“æœ â†’ DocumentCardåˆ—è¡¨
```

**æ‰€æœ‰æ•°æ®æµå·²éªŒè¯å®Œæ•´ï¼** ğŸ‰
