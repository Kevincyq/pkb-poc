# 修复后的Nginx配置建议
# 在 location /api/ 块中添加以下配置：

location /api/ {
    proxy_pass http://pkb_test_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;  # 已有，很好
    
    # 🔧 添加以下配置来修复重定向问题：
    proxy_redirect http://pkb-test.kmchat.cloud/ https://pkb-test.kmchat.cloud/;
    proxy_redirect http://$host/ https://$host/;
    
    # 🔧 或者使用更通用的配置：
    # proxy_redirect ~^http://([^/]+)(.*)$ https://$1$2;
    
    # 🔧 确保FastAPI知道原始协议
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header X-Url-Scheme $scheme;
}
